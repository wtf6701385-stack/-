-- [[ GitHub: NEKO - 修正對接主腳本 ]]
local success, NEKOLib = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/wtf6701385-stack/-/refs/heads/main/NEKOUI?t="..tick()))()
end)

if not success or not NEKOLib then
    warn("❌ NEKO UI 載入失敗！")
    return
end

local Lib = NEKOLib:Init()
local player = game:GetService("Players").LocalPlayer

-- [[ 全域變數初始化 ]]
_G.PVP = false
_G.MOB = false
_G.FastAttack = false
_G.CurrentFastAtkID = ""

-- 核心關閉函數 (確保乾淨重啟)
local function KillCombat()
    _G.FastAttack = false
    _G.CurrentFastAtkID = "KILL_" .. tick()
    task.wait(0.2) -- 給遠端核心自殺的時間
end

-- --- UI 構建 --- --
local Tab1 = Lib:CreateTab("貓戰鬥", false)
local btnPVP, btnMOB

-- PVP 模式按鈕
btnPVP = Tab1:AddButton("打架模式 : OFF", function(self)
    _G.PVP = not _G.PVP
    if _G.PVP then
        _G.MOB = false
        if btnMOB then btnMOB.Text = "  刷怪模式 : OFF" end
        KillCombat() -- 先殺掉舊的
        
        -- 發送生命 ID 並啟動
        _G.CurrentFastAtkID = "LIVE_PVP_" .. tick()
        _G.FastAttack = true
        loadstring(game:HttpGet("https://raw.githubusercontent.com/wtf6701385-stack/-/refs/heads/main/NEKOPVP"))()
    else
        KillCombat()
    end
    self.Text = "  打架模式 : " .. (_G.PVP and "ON" or "OFF")
end)

-- MOB 模式按鈕
btnMOB = Tab1:AddButton("刷怪模式 : OFF", function(self)
    _G.MOB = not _G.MOB
    if _G.MOB then
        _G.PVP = false
        if btnPVP then btnPVP.Text = "  打架模式 : OFF" end
        KillCombat()
        
        -- 發送生命 ID 並啟動
        _G.CurrentFastAtkID = "LIVE_MOB_" .. tick()
        _G.FastAttack = true
        loadstring(game:HttpGet("https://raw.githubusercontent.com/wtf6701385-stack/-/refs/heads/main/NEKOMOB"))()
    else
        KillCombat()
    end
    self.Text = "  刷怪模式 : " .. (_G.MOB and "ON" or "OFF")
end)

-- 其他功能 (保留原樣)
local Tab2 = Lib:CreateTab("貓功能", false)
Tab2:AddButton("貓貓神速", function() loadstring(game:HttpGet("https://raw.githubusercontent.com/wtf6701385-stack/-/refs/heads/main/NEKOSPD"))() end)
Tab2:AddButton("貓貓透視", function() loadstring(game:HttpGet("https://raw.githubusercontent.com/wtf6701385-stack/-/refs/heads/main/NEKOESP"))() end)

print("--- 貓貓主腳本：生命對接已優化 ---")
