local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- 【新增】脚本唯一身份标识，用于防止后台死循环堆积
local scriptId = "NekoESP_" .. tick()
_G.CurrentESP_ID = scriptId

-- 自动适应你的 UI 名称
local gui = player:WaitForChild("PlayerGui"):FindFirstChild("CatCat_Final_Neko") or player:WaitForChild("PlayerGui"):FindFirstChild("CatCat_Qin_UI") or Instance.new("ScreenGui", player.PlayerGui)

local ESPF = gui:FindFirstChild("ESP_Folder") or Instance.new("Folder", gui)
ESPF.Name = "ESP_Folder"

local ESPM, ESPC = {}, {}

local function getRoot(c) return c and (c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("Torso")) end

local function clearE(p) 
    if ESPM[p] then 
        ESPM[p]:Destroy()
        ESPM[p] = nil 
    end 
end

local function attE(p, char)
    clearE(p)
    local hrp = getRoot(char)
    if not hrp then return end
    
    local bb = Instance.new("BillboardGui", ESPF)
    bb.Adornee = hrp; bb.AlwaysOnTop = true; bb.Size = UDim2.new(0, 200, 0, 40)
    bb.ExtentsOffset = Vector3.new(0, 3, 0)
    
    local txt = Instance.new("TextLabel", bb)
    txt.Size = UDim2.new(1, 0, 1, 0); txt.BackgroundTransparency = 1; txt.TextColor3 = Color3.new(1, 1, 1)
    txt.TextStrokeTransparency = 0; txt.Font = Enum.Font.SourceSansBold; txt.TextSize = 14
    
    ESPM[p] = bb
    
    task.spawn(function()
        -- 这里的判断加入了 scriptId 校验，确保旧脚本会自动停止
        while _G.CurrentESP_ID == scriptId and (_G.ESP or _G.ESP_ENABLED) and bb.Parent and p.Character do
            local me, tg = getRoot(player.Character), getRoot(p.Character)
            if me and tg then 
                txt.Text = p.Name .. " [" .. math.floor((me.Position - tg.Position).Magnitude) .. "m]" 
            end
            task.wait(0.2)
        end
        clearE(p)
    end)
end

local function hookP(p)
    if p == player then return end
    if (_G.ESP or _G.ESP_ENABLED) and p.Character then attE(p, p.Character) end
    if ESPC[p] then ESPC[p]:Disconnect() end
    ESPC[p] = p.CharacterAdded:Connect(function(c) 
        -- 检查 ID，如果是旧脚本的连接，则自动断开
        if _G.CurrentESP_ID ~= scriptId then 
            if ESPC[p] then ESPC[p]:Disconnect() end 
            return 
        end
        if (_G.ESP or _G.ESP_ENABLED) then task.wait(0.5); attE(p, c) end 
    end)
end

-- 初始化連線
for _, p in ipairs(Players:GetPlayers()) do hookP(p) end
local playerAddedConn = Players.PlayerAdded:Connect(hookP)
local playerRemovingConn = Players.PlayerRemoving:Connect(function(p) clearE(p); if ESPC[p] then ESPC[p]:Disconnect(); ESPC[p] = nil end end)

-- 監控循環：當開關切換為 OFF 時強制清理
task.spawn(function()
    local last = false
    -- 【关键修改】只有 ID 匹配时才运行，否则旧脚本的循环会自行结束
    while _G.CurrentESP_ID == scriptId do
        local current = (_G.ESP or _G.ESP_ENABLED)
        if current ~= last then
            last = current
            if not last then
                for p in pairs(ESPM) do clearE(p) end
            else
                for _, p in ipairs(Players:GetPlayers()) do hookP(p) end
            end
        end
        task.wait(0.5)
    end
    
    -- 当循环结束（即脚本被替换或关闭）时，彻底断开主连接
    playerAddedConn:Disconnect()
    playerRemovingConn:Disconnect()
    for p in pairs(ESPM) do clearE(p) end
    for p in pairs(ESPC) do if ESPC[p] then ESPC[p]:Disconnect() end end
    print("旧的 ESP 脚本已完全清理。")
end)
