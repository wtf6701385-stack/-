task.spawn(function()
    while _G.ESPStarted do
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= LocalPlayer then
                local char = p.Character
                local hrp = char and char:FindFirstChild("HumanoidRootPart")
                local hum = char and char:FindFirstChildOfClass("Humanoid")
                
                -- æ ¸å¿ƒåˆ¤å®š
                if _G.NekoESP and char and hrp and hum and hum.Health > 0 then
                    local bb = Folder:FindFirstChild(p.Name) or Instance.new("BillboardGui", Folder)
                    bb.Name = p.Name; bb.Adornee = hrp; bb.AlwaysOnTop = true
                    bb.Size = UDim2.new(0, 160, 0, 60); bb.ExtentsOffset = Vector3.new(0, 4, 0); bb.Enabled = true
                    
                    -- [[ âœ¨ é—œéµä¿®æ­£ï¼šæ¯æ¬¡å¾ªç’°é‡æ–°è¨ˆç®—è¡€é‡æ•¸å€¼ âœ¨ ]]
                    local healthPercent = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
                    local healthColor = Color3.fromRGB(100, 255, 100):Lerp(Color3.fromRGB(255, 50, 50), 1 - healthPercent)
                    
                    -- 1. æ›´æ–°åå­—èˆ‡é¡è‰²
                    local nameL = bb:FindFirstChild("NameL") or Instance.new("TextLabel", bb)
                    nameL.Text = "ğŸ¾ " .. p.Name
                    
                    -- 2. æ›´æ–°æ•¸æ“šæ–‡å­— (ç™¾åˆ†æ¯”èˆ‡è·é›¢)
                    local statsL = bb:FindFirstChild("StatsL") or Instance.new("TextLabel", bb)
                    local lroot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    local dist = lroot and math.floor((hrp.Position - lroot.Position).Magnitude) or 0
                    statsL.TextColor3 = healthColor
                    statsL.Text = string.format("[ %d%% ]  [ %dm ]", math.floor(healthPercent * 100), dist)
                    
                    -- 3. æ›´æ–°è¡€æ¢é•·åº¦ (é€™å°±æ˜¯åŸæœ¬ä¸æœƒå‹•çš„åœ°æ–¹å–µï¼)
                    local barBg = bb:FindFirstChild("BarBg") or Instance.new("Frame", bb)
                    local bar = barBg:FindFirstChild("Bar") or Instance.new("Frame", barBg)
                    
                    -- å¼·åˆ¶æ›´æ–°é•·åº¦èˆ‡é¡è‰²
                    bar.Size = UDim2.new(healthPercent, 0, 1, 0)
                    bar.BackgroundColor3 = healthColor

                    -- 4. æ›´æ–° Highlight é¡è‰²
                    local highlight = char:FindFirstChild("NekoHighlight") or Instance.new("Highlight", char)
                    highlight.Enabled = true
                    highlight.FillColor = healthColor
                else
                    -- éš±è—è™•ç†...
                    if Folder:FindFirstChild(p.Name) then Folder[p.Name].Enabled = false end
                    if char and char:FindFirstChild("NekoHighlight") then char.NekoHighlight.Enabled = false end
                end
            end
        end
        task.wait(0.1) -- èª¿æ•´åˆ·æ–°ç‡ï¼Œå…¼é¡§æµæš¢èˆ‡æ•ˆèƒ½
    end
end)
