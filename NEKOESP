-- [[ ğŸ‘ï¸ NEKO SENSE - ULTIMATE FIX (Clean Ver.) ğŸ¾ ]] --

if _G.ESPStarted then _G.ESPStarted = false; task.wait(0.3) end
_G.ESPStarted = true

local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

-- å»ºç«‹/æŠ“å–å®¹å™¨ (æ”¾åœ¨ CoreGui é˜²æ­¢è¢«éŠæˆ²åˆªé™¤)
local Folder = CoreGui:FindFirstChild("NekoESP") or Instance.new("Folder", CoreGui)
Folder.Name = "NekoESP"

-- ğŸ§¹ é¡å¤–æ›ä¸€å€‹ç›£è½ï¼šç©å®¶ä¸€é›¢é–‹ï¼Œç«‹åˆ»åˆªé™¤å°æ‡‰çš„ GUI
local removeConn = Players.PlayerRemoving:Connect(function(p)
    if Folder:FindFirstChild(p.Name) then
        Folder[p.Name]:Destroy()
    end
end)

task.spawn(function()
    while _G.ESPStarted do
        -- 1. æ›´æ–°ç¾æœ‰ç©å®¶ (ä½ çš„åŸå§‹é‚è¼¯)
        for _, p in ipairs(Players:GetPlayers()) do
            pcall(function() 
                if p ~= LocalPlayer then
                    local char = p.Character
                    local hrp = char and char:FindFirstChild("HumanoidRootPart")
                    local hum = char and char:FindFirstChildOfClass("Humanoid")
                    
                    -- æª¢æŸ¥ä¸»äººåœ¨ä¸» UI çš„é–‹é—œ (_G.NekoESP)
                    if _G.NekoESP and char and hrp and hum and hum.Health > 0 then
                        
                        -- [A] BillboardGui æ ¸å¿ƒ
                        local bb = Folder:FindFirstChild(p.Name) or Instance.new("BillboardGui", Folder)
                        bb.Name = p.Name; bb.Adornee = hrp; bb.AlwaysOnTop = true
                        bb.Size = UDim2.new(0, 160, 0, 70); bb.ExtentsOffset = Vector3.new(0, 4.5, 0)
                        bb.Enabled = true
                        
                        -- è¨ˆç®—è¡€é‡é¡è‰²
                        local healthPercent = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
                        local healthColor = Color3.fromRGB(100, 255, 100):Lerp(Color3.fromRGB(255, 50, 50), 1 - healthPercent)
                        
                        -- [B] åå­—æ¨™ç±¤
                        local nameL = bb:FindFirstChild("NameL") or Instance.new("TextLabel", bb)
                        nameL.Name = "NameL"; nameL.Parent = bb
                        nameL.Size = UDim2.new(1, 0, 0.3, 0); nameL.BackgroundTransparency = 1
                        nameL.Font = "GothamBold"; nameL.TextSize = 14; nameL.TextColor3 = Color3.new(1, 1, 1)
                        nameL.TextStrokeTransparency = 0; nameL.Text = "ğŸ¾ " .. p.Name
                        
                        -- [C] æ•¸æ“šæ¨™ç±¤ (è·é›¢ + ç™¾åˆ†æ¯”)
                        local statsL = bb:FindFirstChild("StatsL") or Instance.new("TextLabel", bb)
                        statsL.Name = "StatsL"; statsL.Parent = bb
                        statsL.Size = UDim2.new(1, 0, 0.3, 0); statsL.Position = UDim2.new(0, 0, 0.35, 0)
                        statsL.BackgroundTransparency = 1; statsL.Font = "GothamMedium"; statsL.TextSize = 11
                        
                        local lroot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                        local dist = lroot and math.floor((hrp.Position - lroot.Position).Magnitude) or 0
                        statsL.TextColor3 = healthColor
                        statsL.Text = string.format("[ %d%% ]  [ %dm ]", math.floor(healthPercent * 100), dist)
                        
                        -- [D] é—œéµè¡€æ¢ï¼šèƒŒæ™¯
                        local barBg = bb:FindFirstChild("BarBg") or Instance.new("Frame", bb)
                        barBg.Name = "BarBg"; barBg.Parent = bb
                        barBg.Size = UDim2.new(0.7, 0, 0, 4); barBg.Position = UDim2.new(0.15, 0, 0.7, 0)
                        barBg.BackgroundColor3 = Color3.new(0, 0, 0); barBg.BorderSizePixel = 0
                        
                        -- [E] é—œéµè¡€æ¢ï¼šå‹•æ…‹æ¢
                        local bar = barBg:FindFirstChild("Bar") or Instance.new("Frame", barBg)
                        bar.Name = "Bar"; bar.Parent = barBg
                        bar.BorderSizePixel = 0
                        bar.Size = UDim2.new(healthPercent, 0, 1, 0)
                        bar.BackgroundColor3 = healthColor

                        -- [F] Highlight é€è¦–
                        local highlight = char:FindFirstChild("NekoHighlight") or Instance.new("Highlight", char)
                        highlight.Name = "NekoHighlight"; highlight.Adornee = char
                        highlight.Enabled = true; highlight.FillColor = healthColor; highlight.FillTransparency = 0.75
                        highlight.OutlineColor = Color3.new(1, 1, 1); highlight.OutlineTransparency = 0
                    else
                        -- éš±è— logic (é‡å°æ­»äº¡æˆ–é–‹é—œé—œé–‰)
                        if Folder:FindFirstChild(p.Name) then Folder[p.Name].Enabled = false end
                        if char and char:FindFirstChild("NekoHighlight") then char.NekoHighlight.Enabled = false end
                    end
                end
            end)
        end

        -- ğŸ§¹ 2. é—œéµä¿®å¾©ï¼šæª¢æŸ¥æ®˜ç•™åƒåœ¾
        -- é€™è£¡æœƒæƒæ GUI è³‡æ–™å¤¾ï¼Œå¦‚æœç™¼ç¾åå­—å°æ‡‰çš„ç©å®¶ä¸åœ¨éŠæˆ²è£¡äº†ï¼Œå°±æŠŠå®ƒåˆªæ‰ï¼
        for _, gui in ipairs(Folder:GetChildren()) do
            if not Players:FindFirstChild(gui.Name) then
                gui:Destroy()
            end
        end

        task.wait(0.1) -- ä¿æŒé †æ»‘
    end
    
    -- è…³æœ¬é—œé–‰æ™‚çš„æ¸…ç†
    if removeConn then removeConn:Disconnect() end
    Folder:ClearAllChildren()
end)
