-- [[ 雲端 NEKODET 內容 ]]
_G.TargetCache = { Enemies = {}, Players = {} }

local function GetRoot(c) return c and (c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("Head")) end
local function IsAlive(c)
    local h = c and c:FindFirstChildOfClass("Humanoid")
    return h and h.Health > 0
end

-- 啟動偵測
task.spawn(function()
    -- 使用 repeat 確保執行時如果 _G.PVP 還沒被設定，腳本會等它開啟，而不是直接結束
    repeat task.wait(0.5) until _G.PVP 
    
    while _G.PVP do
        local pTemp, eTemp = {}, {}
        local myRoot = GetRoot(game.Players.LocalPlayer.Character)
        if myRoot then
            local myPos = myRoot.Position
            -- 玩家掃描
            local chars = workspace:FindFirstChild("Characters")
            if chars then
                for _, m in ipairs(chars:GetChildren()) do
                    if m ~= game.Players.LocalPlayer.Character and IsAlive(m) then
                        local r = GetRoot(m)
                        if r and (r.Position - myPos).Magnitude <= 1500 then
                            table.insert(pTemp, {m, r}) -- 保持 {模型, 零件} 格式
                        end
                    end
                end
            end
            -- 怪物掃描
            local enems = workspace:FindFirstChild("Enemies")
            if enems then
                for _, m in ipairs(enems:GetChildren()) do
                    if IsAlive(m) then
                        local r = GetRoot(m)
                        if r and (r.Position - myPos).Magnitude <= 1500 then
                            table.insert(eTemp, {m, r}) -- 保持 {模型, 零件} 格式
                        end
                    end
                end
            end
        end
        _G.TargetCache.Players = pTemp
        _G.TargetCache.Enemies = eTemp
        
        -- 既然怪物不多，改為 0.1 秒完全沒問題，會靈敏很多
        task.wait(0.1)
    end
end)
warn("!!! NEKODET CLOUD LOADED !!!")
