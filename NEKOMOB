-- [[ Neko MOB 修正版：BF 多功能練級 (刀/格鬥/果實 分離邏輯) ]]
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local scriptId = "NekoMob_BF_Hybrid_" .. tick()
_G.CurrentMobID = scriptId

local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegAttack, RegHit = Net:WaitForChild("RE/RegisterAttack"), Net:WaitForChild("RE/RegisterHit")

local function getRoot(c) return c and (c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("Torso")) end

local function isEnemy(c)
    local h = c and c:FindFirstChildOfClass("Humanoid")
    if h and h.Health > 0 and h.MaxHealth > 100 then
        local name = c.Name:lower()
        if name:find("npc") or name:find("shop") or name:find("quest") or name:find("deal") then
            return false
        end
        return true
    end
    return false
end

local Targets = {}

-- [[ 掃描線程 ]]：維持 2500 範圍拉怪（不變）
task.spawn(function()
    local p = OverlapParams.new()
    while _G.CurrentMobID == scriptId do
        if _G.MOB or _G.PVP then
            local mr = getRoot(player.Character)
            if mr then
                local filtered = {}
                local parts = workspace:GetPartBoundsInRadius(mr.Position, 2500, p)
                for _, v in ipairs(parts) do
                    local m = v.Parent
                    if m and m ~= player.Character and isEnemy(m) then
                        local isP = Players:GetPlayerFromCharacter(m)
                        if (isP and _G.PVP) or (not isP and _G.MOB) then
                            if not table.find(filtered, m) then
                                table.insert(filtered, m)
                            end
                        end
                    end
                    if #filtered >= 50 then break end
                end
                Targets = filtered
            end
        else Targets = {} end
        task.wait(0.5)
    end
end)

-- [[ 動作線程 ]]：分離刀、格鬥與果實邏輯
task.spawn(function()
    while _G.CurrentMobID == scriptId do
        if (_G.MOB or _G.PVP) and #Targets > 0 then
            local char = player.Character
            local root = getRoot(char)
            local tool = char and char:FindFirstChildOfClass("Tool")
            
            if tool and root then
                local hitList = {}
                -- 核心偵測：識別 BF 武器類型
                local toolType = tool.ToolTip 
                
                for _, mob in ipairs(Targets) do
                    local tr = getRoot(mob)
                    if tr then
                        -- 【邏輯分流】
                        if toolType == "Blox Fruit" then
                            -- 果實：拉到面前 (X=0, Y=2, Z=-5)，確保普攻與技能 Mastery 判定成功
                            tr.CFrame = root.CFrame * CFrame.new(0, 2, -5)
                        elseif toolType == "Sword" or toolType == "Melee" then
                            -- 刀與格鬥：拉到高空 100 米，絕對安全防禦
                            tr.CFrame = root.CFrame * CFrame.new(0, 100, 0)
                        else
                            -- 其他物品預設拉高
                            tr.CFrame = root.CFrame * CFrame.new(0, 100, 0)
                        end
                        
                        -- 距離判定：200 碼內進入攻擊列表
                        local dist = (tr.Position - root.Position).Magnitude
                        if dist <= 200 then
                            table.insert(hitList, {mob, tr})
                        end
                    end
                end
                
                -- 發送封包：手上拿什麼，經驗就歸誰
                if #hitList > 0 then
                    RegAttack:FireServer(0)
                    for _, data in ipairs(hitList) do
                        -- BF RegisterHit 封包
                        RegHit:FireServer(data[2], hitList)
                    end
                end
            end
        end
        RunService.Heartbeat:Wait()
    end
end)

print("Neko MOB: BF 多功能版已啟動！")
print("偵測中：切換果實怪會移至面前，切換刀/格鬥怪會飛向高空。")
