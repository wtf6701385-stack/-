-- [[ Neko MOB：BF 多模式切換自殺版 ]]
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

-- 全域變數控制
_G.CurrentMobID = tick()
local currentMode = "" -- 記錄當前模式：Melee, Sword, Fruit

local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegAttack, RegHit = Net:WaitForChild("RE/RegisterAttack"), Net:WaitForChild("RE/RegisterHit")

local function getRoot(c) return c and (c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("Torso")) end

local function isEnemy(c)
    local h = c and c:FindFirstChildOfClass("Humanoid")
    if h and h.Health > 0 and h.MaxHealth > 100 then
        local name = c.Name:lower()
        if name:find("npc") or name:find("shop") or name:find("quest") or name:find("deal") then
            return false
        end
        return true
    end
    return false
end

-- 掃描線程 (持續運作，不參與自殺)
local Targets = {}
task.spawn(function()
    local p = OverlapParams.new()
    local myID = _G.CurrentMobID
    while _G.CurrentMobID == myID do
        if _G.MOB then
            local mr = getRoot(player.Character)
            if mr then
                local filtered = {}
                local parts = workspace:GetPartBoundsInRadius(mr.Position, 2500, p)
                for _, v in ipairs(parts) do
                    local m = v.Parent
                    if m and m ~= player.Character and isEnemy(m) then
                        if not table.find(filtered, m) then table.insert(filtered, m) end
                    end
                    if #filtered >= 50 then break end
                end
                Targets = filtered
            end
        end
        task.wait(0.5)
    end
end)

-- [[ 核心邏輯：自動偵測並切換模式 ]]
task.spawn(function()
    local myID = _G.CurrentMobID
    local activeThread = nil -- 用來存儲當前的攻擊線程

    while _G.CurrentMobID == myID do
        local char = player.Character
        local tool = char and char:FindFirstChildOfClass("Tool")
        
        if tool then
            local toolType = tool.ToolTip
            local newMode = ""

            -- 判定新模式
            if toolType == "Blox Fruit" then newMode = "Fruit"
            elseif toolType == "Sword" then newMode = "Sword"
            elseif toolType == "Melee" then newMode = "Melee"
            end

            -- 如果模式切換了，就殺死舊的，啟動新的
            if newMode ~= "" and newMode ~= currentMode then
                currentMode = newMode
                
                -- 1. 殺死前一個攻擊方式 (自殺邏輯)
                if activeThread then
                    task.cancel(activeThread)
                    activeThread = nil
                    print("模式切換：" .. currentMode .. " 啟動，舊模式已自殺。")
                end

                -- 2. 啟動對應模式的攻擊線程
                activeThread = task.spawn(function()
                    while currentMode == newMode do
                        if #Targets > 0 and getRoot(char) then
                            local hitList = {}
                            local root = getRoot(char)
                            
                            for _, mob in ipairs(Targets) do
                                local tr = getRoot(mob)
                                if tr then
                                    -- 分流拉怪邏輯
                                    if newMode == "Fruit" then
                                        -- 果實專屬：拉到面前
                                        tr.CFrame = root.CFrame * CFrame.new(0, -1, -8)
                                    else
                                        -- 刀/格鬥：拉到高空
                                        tr.CFrame = root.CFrame * CFrame.new(0, 100, 0)
                                    end
                                    
                                    if (tr.Position - root.Position).Magnitude <= 200 then
                                        table.insert(hitList, {mob, tr})
                                    end
                                end
                            end

                            if #hitList > 0 then
                                RegAttack:FireServer(0)
                                for _, data in ipairs(hitList) do
                                    RegHit:FireServer(data[2], hitList)
                                end
                            end
                        end
                        RunService.Heartbeat:Wait()
                    end
                end)
            end
        end
        task.wait(0.1) -- 偵測工具切換的頻率
    end
end)

print("Neko MOB: 模式自殺切換系統已啟動。")
