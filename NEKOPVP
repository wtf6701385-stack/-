-- [[ NEKO x å‡Œéœ„ 2025 : ç´”ç²¹å¼·æ‹½ x è™›æ“¬å¡«å……æ ¸å¿ƒ ]]
-- æ ¸å¿ƒé‚è¼¯ï¼šä¸»äººä¸å‹•ï¼Œçµç‰©éä¾†ï¼Œè¡€é‡ > 0 æ‰æŠ“

if not _G.FastAttack then return end
local SessionID = _G.CurrentFastAtkID
local LP = game.Players.LocalPlayer

local Net = game:GetService("ReplicatedStorage"):WaitForChild("Modules"):WaitForChild("Net")
local RegAttack = Net:WaitForChild("RE/RegisterAttack")
local RegHit = Net:WaitForChild("RE/RegisterHit")

-- [ æ•ç²é…ç½® ]
local Config = {
    PlayerDist = 5000,   -- 5000 é–å®šç©å®¶æ•¸æ“š
    BringDist = 1500,    -- 1500 å¼·è¡Œæ‹‰åˆ°é¢å‰
    MaxTargets = 20,
    MinDelay = 0.08, 
    MaxDelay = 0.15 
}

-- [ æ ¸å¿ƒï¼šç´”ç²¹æ‹‰äººé‚è¼¯ ]
local function ProcessTargets()
    local targets = {}
    local char = LP.Character
    if not (char and char:FindFirstChild("HumanoidRootPart")) then return targets end
    local myRoot = char.HumanoidRootPart
    local myPos = myRoot.Position
    
    local candidates = {}
    
    -- 1. è’é›†ç©å®¶èˆ‡æ€ªç‰© (çµ±ä¸€é‚è¼¯)
    for _, v in pairs(workspace:GetChildren()) do
        local h = v:FindFirstChild("Humanoid")
        local root = v:FindFirstChild("HumanoidRootPart")
        if h and h.Health > 0 and root and v ~= char then
            local isPlayer = game.Players:GetPlayerFromCharacter(v)
            local dist = (root.Position - myPos).Magnitude
            
            -- åˆ†æ®µåˆ¤æ–·ï¼šç©å®¶ 5000ï¼Œæ€ªç‰© 1500
            if (isPlayer and dist <= Config.PlayerDist) or (not isPlayer and dist <= Config.MonsterDist) then
                table.insert(candidates, {v = v, r = root, dist = dist})
            end
        end
    end

    -- 2. åŸ·è¡Œå¼·æ‹½èˆ‡æ‰“åŒ…
    for i, data in ipairs(candidates) do
        if i > Config.MaxTargets then break end
        
        -- ã€é—œéµï¼šåªæ‹‰æ•µäººï¼Œä¸»äººçµ•å°ä¸å‹•ã€‘
        -- åªè¦åœ¨ 1500 å…§ï¼Œå°±æŠŠå°æ–¹çš„åº§æ¨™å¼·è¡Œä¿®æ”¹åˆ°ä¸»äººé¢å‰ 3 æ ¼
        if data.dist <= Config.BringDist then
            pcall(function()
                data.r.CFrame = myRoot.CFrame * CFrame.new(0, 0, -3)
            end)
        end
        table.insert(targets, {data.v, data.r})
    end
    return targets
end

-- ==========================================
-- ã€æ ¸å¿ƒ Aï¼šè¨Šè™Ÿç¡¬çŒã€‘
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        local tool = LP.Character and LP.Character:FindFirstChildOfClass("Tool")
        if tool then
            -- æ¨¡æ“¬æ®åˆ€å‹•ç•«ï¼Œä½†ä¸ç§»å‹•å¯¦é«”
            task.spawn(function() tool:Activate() end)
            RegAttack:FireServer(0.125)
        end
        task.wait(math.random(Config.MinDelay * 100, Config.MaxDelay * 100) / 100)
    end
end)

-- ==========================================
-- ã€æ ¸å¿ƒ Bï¼šç©ºé–“å¡«å……å¼•æ“ã€‘
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        game:GetService("RunService").RenderStepped:Wait()
        local tool = LP.Character and LP.Character:FindFirstChildOfClass("Tool")
        if tool then
            local enemies = ProcessTargets()
            if #enemies > 0 then
                local hitData = {}
                for _, data in ipairs(enemies) do
                    table.insert(hitData, {data[1], data[2]})
                end
                -- ç¡¬çŒå‘½ä¸­æ•¸æ“šï¼Œç„¡è¦–è·é›¢åˆ¤å®š
                pcall(function()
                    for i = 1, 8 do 
                        RegHit:FireServer(tool, hitData)
                    end
                end)
            end
        end
    end
    print("ğŸ’€ å‡Œéœ„å¼·æ‹½æ ¸å¿ƒï¼šæ¸…ç†å®Œç•¢ã€‚")
end)
