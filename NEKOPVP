-- [[ GitHub: NEKOPVP - ç¥åˆ€æ”»æ“Šå¼•æ“ (ç©©å®šå„ªåŒ–ç‰ˆ) ]]
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LP = Players.LocalPlayer

-- é˜²æ­¢é‡è¤‡åŸ·è¡Œå¾ªç’°
if _G.PVP_Loop_Started then return end
_G.PVP_Loop_Started = true

-- [[ 1. æ ¸å¿ƒçµ„ä»¶ç²å–å‡½æ•¸ ]]
local function GetCore()
    local modules = ReplicatedStorage:FindFirstChild("Modules")
    local net = modules and modules:FindFirstChild("Net")
    if net then
        return net:FindFirstChild("RE/RegisterAttack"), net:FindFirstChild("RE/RegisterHit")
    end
    return nil, nil
end

local function IsAlive(char)
    return char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0
end

-- [[ 2. æ ¸å¿ƒå¾ªç’° ]]
task.spawn(function()
    print("ğŸš€ ç¥åˆ€å¼•æ“(PVP)ï¼šä½µç™¼å”è­°å•Ÿå‹•ï¼")
    
    while true do
        -- åªæœ‰åœ¨é–‹é—œé–‹å•Ÿä¸”ä¸»è…³æœ¬æ²’æœ‰æ­£åœ¨é‡è¼‰æ™‚é‹è¡Œ
        if _G.PVP then
            local success, err = pcall(function()
                local RegAtk, RegHit = GetCore()
                if not RegAtk or not RegHit then return end
                
                local char = LP.Character
                local myRoot = char and char:FindFirstChild("HumanoidRootPart")
                if not myRoot then return end
                
                local tool = char:FindFirstChildOfClass("Tool")
                if not (tool and tool.ToolTip ~= "Gun") then return end

                local targets = {}
                local mainPart = nil
                
                -- ç²å–æ‰€æœ‰ç©å®¶ä¸¦ç¯©é¸
                local allPlayers = Players:GetPlayers()
                for i = 1, #allPlayers do
                    local p = allPlayers[i]
                    if p ~= LP and p.Character then
                        local root = p.Character:FindFirstChild("HumanoidRootPart") or p.Character:FindFirstChild("Head")
                        if root and IsAlive(p.Character) then
                            -- è·é›¢åˆ¤å®š
                            if (root.Position - myRoot.Position).Magnitude < 5000 then
                                if not mainPart then mainPart = root end
                                table.insert(targets, {p.Character, root})
                            end
                        end
                    end
                    -- é™åˆ¶å–®æ¬¡å°åŒ…ç›®æ¨™æ•¸ï¼Œé˜²æ­¢ä¼ºæœå™¨è¸¢å‡º (25å€‹ç›®æ¨™æ˜¯å®‰å…¨é–¾å€¼)
                    if #targets >= 25 then break end
                end
                
                -- åŸ·è¡Œæ”»æ“Šå°åŒ…
                if #targets > 0 and mainPart then
                    RegAtk:FireServer(0.1) 
                    RegHit:FireServer(mainPart, targets)
                end
            end)
            
            if not success then
                warn("PVP å¼•æ“å¾ªç’°å…§å‡ºéŒ¯: " .. tostring(err))
            end
        end
        
        -- æ§åˆ¶æƒæé »ç‡ï¼Œ0.1s æ˜¯å¹³è¡¡æ€§èƒ½èˆ‡å¨åŠ›çš„æœ€ä½³é»
        task.wait(0.1) 
    end
end)
