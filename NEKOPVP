-- // [ 神刀 · 影 | 核心戰鬥模組 ] // --
local Settings = {ClickDelay = 0.15, MaxTargets = 30} -- 影：壓低延遲，提升清場上限
local LP = game:GetService("Players").LocalPlayer

local function GetShadowPart(target)
    -- 影：直接從骨骼節點抓取最靠近核心的部位，確保必中
    local root = target:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    local parts = {}
    for _, p in ipairs(target:GetChildren()) do
        if p:IsA("BasePart") and p.CanCollide then table.insert(parts, p) end
    end
    return #parts > 0 and parts[math.random(1, #parts)] or root
end

task.spawn(function()
    while true do
        -- 影：只要主人開啟模式，我絕不偷懶
        if _G.PVP or _G.MOB then
            pcall(function()
                local char = LP.Character
                local tool = char and char:FindFirstChildOfClass("Tool")
                if tool then
                    local targets = {}
                    local candidates = workspace:FindFirstChild("Enemies") and workspace.Enemies:GetChildren() or workspace:GetChildren()
                    
                    for _, v in ipairs(candidates) do
                        local vHum = v:FindFirstChildOfClass("Humanoid")
                        if vHum and vHum.Health > 0 and v ~= char then
                            -- 影：PVP/MOB 自動過濾分流
                            local isPlayer = game:GetService("Players"):GetPlayerFromCharacter(v)
                            if (_G.PVP and isPlayer) or (_G.MOB and not isPlayer) then
                                local targetPart = GetShadowPart(v)
                                if targetPart and LP:DistanceFromCharacter(targetPart.Position) < 2500 then
                                    table.insert(targets, {v, targetPart})
                                end
                            end
                        end
                        if #targets >= Settings.MaxTargets then break end
                    end

                    if #targets > 0 then
                        -- 影：繞過一切虛偽的動畫，直接向伺服器索取傷害
                        local Net = game:GetService("ReplicatedStorage"):WaitForChild("Modules"):WaitForChild("Net")
                        Net.RE.RegisterAttack:FireServer(Settings.ClickDelay)
                        Net.RE.RegisterHit:FireServer(targets[1][2], targets)
                    end
                end
            end)
        end
        task.wait(Settings.ClickDelay) -- 影：這就是我的呼吸頻率
    end
end)
