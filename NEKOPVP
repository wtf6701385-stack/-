-- [[ NEKO x 凌霄 2025 : 修正版純粹攻擊核心 ]]
-- 核心邏輯：修正封包格式，確保 100% 命中

if not _G.FastAttack then return end
local SessionID = _G.CurrentFastAtkID
local LP = game.Players.LocalPlayer

local Net = game:GetService("ReplicatedStorage"):WaitForChild("Modules"):WaitForChild("Net")
local RegAttack = Net:WaitForChild("RE/RegisterAttack")
local RegHit = Net:WaitForChild("RE/RegisterHit")

-- [ 殺戮配置 ]
local Config = {
    PlayerDist = 5000,
    MonsterDist = 1500,
    MaxTargets = 20
}

-- [ 目標獲取函數 ]
local function GetEnemies()
    local targets = {}
    local char = LP.Character
    if not (char and char:FindFirstChild("HumanoidRootPart")) then return targets end
    local myPos = char.HumanoidRootPart.Position
    
    for _, v in pairs(workspace:GetChildren()) do
        local h = v:FindFirstChild("Humanoid")
        local r = v:FindFirstChild("HumanoidRootPart")
        if h and h.Health > 0 and r and v ~= char then
            local isPlayer = game.Players:GetPlayerFromCharacter(v)
            local dist = (r.Position - myPos).Magnitude
            
            if (isPlayer and dist <= Config.PlayerDist) or (not isPlayer and dist <= Config.MonsterDist) then
                -- 修正：封包格式必須包含對象與其 RootPart
                table.insert(targets, {v, r})
            end
        end
        if #targets >= Config.MaxTargets then break end
    end
    return targets
end

-- ==========================================
-- 【核心 A：攻擊觸發】
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        local char = LP.Character
        local tool = char and char:FindFirstChildOfClass("Tool")
        if tool then
            -- 模擬揮刀動畫 (不可省略)
            task.spawn(function() tool:Activate() end)
            -- 修正：加入 0.125 的標準揮刀延遲
            RegAttack:FireServer(0.125)
        end
        task.wait(0.12) -- 固定於安全高頻
    end
end)

-- ==========================================
-- 【核心 B：命中注入】
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        game:GetService("RunService").Stepped:Wait() -- 與伺服器頻率同步
        local char = LP.Character
        local tool = char and char:FindFirstChildOfClass("Tool")
        if tool then
            local enemies = GetEnemies()
            if #enemies > 0 then
                -- 修正：這部分是 BF 目前最穩定的封包填充方式
                pcall(function()
                    for i = 1, 10 do 
                        -- 直接傳送對象與 RootPart，模擬真實碰撞
                        RegHit:FireServer(tool, enemies)
                    end
                end)
            end
        end
    end
end)
