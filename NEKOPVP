-- [[ NEKOPVP - 打架核心 ]]
local Players = game:GetService("Players")
local player = Players.LocalPlayer

local Net = game:GetService("ReplicatedStorage"):WaitForChild("Modules"):WaitForChild("Net")
local RegAttack = Net:WaitForChild("RE/RegisterAttack")
local RegHit = Net:WaitForChild("RE/RegisterHit")

task.spawn(function()
    while true do
        -- 核心：只看開關
        if _G.PVP == true then
            pcall(function()
                local char = player.Character
                local root = char and char:FindFirstChild("HumanoidRootPart")
                local tool = char and char:FindFirstChildOfClass("Tool")
                
                if tool and root then
                    local targets = {}
                    local mainPart = nil
                    
                    for _, p in ipairs(Players:GetPlayers()) do
                        if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                            local tRoot = p.Character.HumanoidRootPart
                            local hum = p.Character:FindFirstChildOfClass("Humanoid")
                            
                            if hum and hum.Health > 0 then
                                -- 範圍內玩家
                                if (tRoot.Position - root.Position).Magnitude < 1000 then
                                    if not mainPart then mainPart = tRoot end
                                    table.insert(targets, p.Character)
                                end
                            end
                        end
                    end
                    
                    if #targets > 0 and mainPart then
                        RegAttack:FireServer(0)
                        RegHit:FireServer(mainPart, targets)
                    end
                end
            end)
        end
        task.wait(0.1)
    end
end)
