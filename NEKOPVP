-- [[ NEKOPVP - OFF即終止自殺版 ]]
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LP = Players.LocalPlayer

local pvpId = tick()
_G.CurrentPvpID = pvpId

local function GetCore()
    local modules = ReplicatedStorage:FindFirstChild("Modules")
    local net = modules and modules:FindFirstChild("Net")
    if net then return net:FindFirstChild("RE/RegisterAttack"), net:FindFirstChild("RE/RegisterHit") end
    return nil, nil
end

task.spawn(function()
    -- 關鍵：當切換到 OFF 時，while 迴圈會結束，腳本宣告死亡
    while _G.CurrentPvpID == pvpId and _G.PVP do
        pcall(function()
            local RegAtk, RegHit = GetCore()
            local char = LP.Character
            local myRoot = char and char:FindFirstChild("HumanoidRootPart")
            local tool = char and char:FindFirstChildOfClass("Tool")
            
            if myRoot and tool and tool.ToolTip ~= "Gun" then
                local targets = {}
                local mainPart = nil
                for _, p in ipairs(Players:GetPlayers()) do
                    if p ~= LP and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                        local hum = p.Character:FindFirstChildOfClass("Humanoid")
                        if hum and hum.Health > 0 then
                            local root = p.Character.HumanoidRootPart
                            if (root.Position - myRoot.Position).Magnitude < 5000 then
                                if not mainPart then mainPart = root end
                                table.insert(targets, p.Character)
                            end
                        end
                    end
                    if #targets >= 25 then break end
                end
                if #targets > 0 and mainPart then
                    RegAtk:FireServer(0.1) 
                    RegHit:FireServer(mainPart, targets)
                end
            end
        end)
        task.wait(0.1) 
    end
end)
