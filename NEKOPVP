-- [[ NEKO x å‡Œéœ„ 2025 : ç´”ç²¹æš´åŠ›å¡«å……æ ¸å¿ƒ ]]
-- æ ¸å¿ƒé‚è¼¯ï¼šçµ•å°ä¸å‹•ä¸»é«”ã€çµ•å°ä¸æ‹‰äººã€ç´”å‚·å®³æ³¨å…¥

if not _G.FastAttack then return end
local SessionID = _G.CurrentFastAtkID
local LP = game.Players.LocalPlayer

local Net = game:GetService("ReplicatedStorage"):WaitForChild("Modules"):WaitForChild("Net")
local RegAttack = Net:WaitForChild("RE/RegisterAttack")
local RegHit = Net:WaitForChild("RE/RegisterHit")

-- [ æš´åŠ›é…ç½® ]
local Config = {
    PlayerDist = 5000,   -- 5000 è·é›¢å…§ç©å®¶å—æ­»
    MonsterDist = 1500,  -- 1500 è·é›¢å…§æ€ªç‰©å—æ­»
    MaxTargets = 20,
    MinDelay = 0.08, 
    MaxDelay = 0.15 
}

-- [ ç´”ç²¹ç›®æ¨™ç²å– ]
local function GetEnemies()
    local targets = {}
    local char = LP.Character
    if not (char and char.PrimaryPart) then return targets end
    local myPos = char.PrimaryPart.Position
    
    local candidates = {}
    for _, v in pairs(workspace:GetChildren()) do
        local h = v:FindFirstChild("Humanoid")
        local root = v:FindFirstChild("HumanoidRootPart")
        if h and h.Health > 0 and root and v ~= char then
            local isPlayer = game.Players:GetPlayerFromCharacter(v)
            local dist = (root.Position - myPos).Magnitude
            
            -- åˆ†æ®µåˆ¤å®šç¯„åœ
            if (isPlayer and dist <= Config.PlayerDist) or (not isPlayer and dist <= Config.MonsterDist) then
                table.insert(candidates, {v = v, r = root})
            end
        end
    end

    -- å°åŒ…æ‰“åŒ… (ä¸Šé™ 20)
    for i = 1, math.min(#candidates, Config.MaxTargets) do
        table.insert(targets, {candidates[i].v, candidates[i].r})
    end
    return targets
end

-- ==========================================
-- ã€æ ¸å¿ƒ Aï¼šè¨Šè™Ÿè§¸ç™¼ã€‘
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        local tool = LP.Character and LP.Character:FindFirstChildOfClass("Tool")
        if tool then
            task.spawn(function() tool:Activate() end)
            RegAttack:FireServer(0.125)
        end
        task.wait(math.random(Config.MinDelay * 100, Config.MaxDelay * 100) / 100)
    end
end)

-- ==========================================
-- ã€æ ¸å¿ƒ Bï¼šæš´åŠ›å¡«å……å¼•æ“ã€‘
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        game:GetService("RunService").RenderStepped:Wait()
        local tool = LP.Character and LP.Character:FindFirstChildOfClass("Tool")
        if tool then
            local enemies = GetEnemies()
            if #enemies > 0 then
                local hitData = {}
                for _, data in ipairs(enemies) do
                    table.insert(hitData, {data[1], data[2]})
                end
                -- æ¥µé™ç¡¬çŒå‘½ä¸­å°åŒ…
                pcall(function()
                    for i = 1, 10 do -- æå‡è‡³ 10 å€å¡«å……
                        RegHit:FireServer(tool, hitData)
                    end
                end)
            end
        end
    end
    print("ğŸ’€ ç´”ç²¹æ ¸å¿ƒï¼šè‡ªæ¯€æˆåŠŸã€‚")
end)
