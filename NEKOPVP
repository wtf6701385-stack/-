-- [[ Neko PVP 核心模組 ]]
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Player = Players.LocalPlayer
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegAttack = Net:WaitForChild("RE/RegisterAttack")
local RegHit = Net:WaitForChild("RE/RegisterHit")

-- 自殺協議：確保重複加載時舊腳本自動停止
local scriptId = "NekoPVP_" .. tick()
_G.CurrentPvpID = scriptId

local MAX_SCAN_COUNT = 30 
local ATTACK_SPEED_PLAYER = 0.06
local ATTACK_SPEED_NPC = 0.1

local function GetRoot(c) return c and (c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("Head")) end
local function IsAlive(c) 
    local h = c and c:FindFirstChildOfClass("Humanoid")
    return h and h.Health > 0 
end

local function ScanEnvironment(myPos, char)
    local found = {}
    local count = 0
    local folders = {workspace:FindFirstChild("Characters"), workspace:FindFirstChild("Enemies"), workspace:FindFirstChild("NPCs")}
    for _, folder in ipairs(folders) do
        if folder then
            local children = folder:GetChildren()
            for i = 1, #children do
                if count >= MAX_SCAN_COUNT then break end
                local m = children[i]
                if m ~= char and IsAlive(m) then
                    local tr = GetRoot(m)
                    if tr and (tr.Position - myPos).Magnitude <= 1500 then
                        table.insert(found, m)
                        count = count + 1
                    end
                end
            end
        end
        if count >= MAX_SCAN_COUNT then break end
    end
    return found
end

local function PreparePackage(models)
    local hitList = {}
    for i = 1, #models do
        local m = models[i]; local root = GetRoot(m)
        if root then table.insert(hitList, {m, root}) end
    end
    return hitList
end

local function SendAttack(targetPart, list)
    RegAttack:FireServer(0); RegHit:FireServer(targetPart, list)
end

task.spawn(function()
    -- 只有當 ID 匹配且全局開關為 ON 時才運行
    while _G.CurrentPvpID == scriptId and _G.PVP do
        local waitTime = 0.1 
        local char = Player.Character; local root = GetRoot(char); local tool = char and char:FindFirstChildOfClass("Tool")
        if tool and root then
            local rawModels = ScanEnvironment(root.Position, char)
            if #rawModels > 0 then
                local finalHitList = PreparePackage(rawModels)
                if #finalHitList > 0 then
                    local primaryRoot = finalHitList[1][2]
                    SendAttack(primaryRoot, finalHitList)
                    local isPlayer = Players:GetPlayerFromCharacter(rawModels[1]) ~= nil
                    waitTime = isPlayer and ATTACK_SPEED_PLAYER or ATTACK_SPEED_NPC
                end
            end
        end
        task.wait(waitTime)
    end
    print("舊的 PVP 腳本已安全釋放")
end)
