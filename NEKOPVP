-- [[ NEKO x 凌霄 2025 : 5000 全域秒殺核心 ]]
-- 核心邏輯：取消分層，5000 內全體隨機零件採樣 + 批量注入

if not _G.FastAttack then return end
local SessionID = _G.CurrentFastAtkID
local LP = game.Players.LocalPlayer
local RS = game:GetService("ReplicatedStorage")
local WS = game:GetService("Workspace")

local Net = RS:WaitForChild("Modules"):WaitForChild("Net")
local RegAttack = Net:WaitForChild("RE/RegisterAttack")
local RegHit = Net:WaitForChild("RE/RegisterHit")

-- [ 殺戮配置 ]
local Config = {
    KillDist = 5000,     -- 只有一個標準：5000 距離
    MaxTargets = 20,
    ClickDelay = 0.1 
}

-- [ 隨機零件採樣 (零式核心精髓) ]
local function GetRandomValidPart(target)
    local allParts = target:GetDescendants()
    local validParts = {}
    for _, part in ipairs(allParts) do
        if part:IsA("BasePart") and part.CanCollide then
            table.insert(validParts, part)
        end
    end
    return #validParts > 0 and validParts[math.random(1, #validParts)] or target:FindFirstChild("HumanoidRootPart")
end

-- [ 全域目標搜刮 ]
local function GetAllTargets()
    local mainPart = nil
    local othersEnemies = {}
    local char = LP.Character
    if not (char and char.PrimaryPart) then return nil, {} end
    local myPos = char.PrimaryPart.Position
    
    local candidates = {}
    
    -- 遍歷所有帶有血量的生物 (不論玩家或怪物)
    for _, v in pairs(WS:GetChildren()) do
        local h = v:FindFirstChild("Humanoid")
        local r = v:FindFirstChild("HumanoidRootPart")
        if h and h.Health > 0 and r and v ~= char then
            if (r.Position - myPos).Magnitude <= Config.KillDist then
                table.insert(candidates, v)
            end
        end
    end

    -- 封裝成零腳本要求的格式
    for i, enemy in ipairs(candidates) do
        if i > Config.MaxTargets then break end
        local part = GetRandomValidPart(enemy)
        if part then
            if not mainPart then mainPart = part end 
            table.insert(othersEnemies, {enemy, part})
        end
    end
    
    return mainPart, othersEnemies
end

-- ==========================================
-- 【秒殺引擎啟動】
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        local tool = LP.Character and LP.Character:FindFirstChildOfClass("Tool")
        if tool and tool.ToolTip ~= "Gun" then
            local mainPart, enemyList = GetAllTargets()
            
            if mainPart and #enemyList > 0 then
                -- 1. 發送揮刀訊號
                RegAttack:FireServer(Config.ClickDelay)
                
                -- 2. 直接注入零式封包
                pcall(function()
                    RegHit:FireServer(mainPart, enemyList)
                end)
            end
        end
        task.wait(Config.ClickDelay)
    end
end)
