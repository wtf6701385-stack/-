-- [[ Neko x FastAttack : 真正的「全自動填充」修復版 ]]
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
-- 重新確認路徑，有些版本會隱藏在不同子目錄下
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")

local Settings = {
    Distance = 3000,
    -- 這裡不再傳送 0，而是模擬一個極其微小但「合法」的數值
    ClickValue = 0.125
}

local function GetValidTargets()
    local heads = {}
    local pChar = game.Players.LocalPlayer.Character
    if not pChar or not pChar:FindFirstChild("HumanoidRootPart") then return heads end
    
    -- 擴大搜索範圍到所有可能的怪物路徑
    local enemyPaths = {workspace:FindFirstChild("Enemies"), workspace:FindFirstChild("Characters"), workspace}
    for _, folder in pairs(enemyPaths) do
        if folder then
            for _, m in pairs(folder:GetChildren()) do
                if m:IsA("Model") and m:FindFirstChild("Humanoid") and m.Humanoid.Health > 0 then
                    local head = m:FindFirstChild("Head") or m:FindFirstChild("HumanoidRootPart")
                    if head and (head.Position - pChar.HumanoidRootPart.Position).Magnitude < Settings.Distance then
                        table.insert(heads, head)
                    end
                end
            end
        end
    end
    return heads
end

task.spawn(function()
    while _G.FastAttack do
        RunService.RenderStepped:Wait() -- 使用渲染步進達到最高同步率
        
        local tool = game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if tool then
            local targets = GetValidTargets()
            if #targets > 0 then
                -- 【核心修復】：先觸發攻擊動作，確保伺服器認為你在揮刀
                RegisterAttack:FireServer(Settings.ClickValue)
                
                -- 【核心修復】：將所有目標一次性寫入 Hit 封包，模仿範圍傷害
                -- 注意：如果還是不行，試著把 targets 改成只傳 targets[1]
                pcall(function()
                    RegisterHit:FireServer(targets[1], targets)
                end)
            end
        end
    end
end)
