-- [[ Neko x FastAttack : High-Speed Edition (Clean Stop Ver.) ]]

-- ===== 0. è‡ªæ®ºå”è­°èˆ‡æ¸…ç† =====
local scriptId = "NekoFastAtk_" .. tick()
_G.CurrentFastAtkID = scriptId

-- ç¢ºä¿å…¨åŸŸé–‹é—œå­˜åœ¨
if _G.FastAttack == nil then _G.FastAttack = true end

-- ===== 1. ç’°å¢ƒèˆ‡åƒæ•¸ =====
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")

local Settings = {
    ClickDelay = 0.06,
    Distance = 5000
}

-- ===== 2. æ ¸å¿ƒé‚è¼¯æ¨¡çµ„ =====
local FastAttackModule = {
    IsRunning = true
}

function FastAttackModule:IsAlive(char)
    return char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0
end

function FastAttackModule:GetTargets()
    local targets = {}
    local myChar = Player.Character
    if not self:IsAlive(myChar) then return targets end
    
    local myPos = myChar.PrimaryPart.Position
    local folders = {workspace:FindFirstChild("Enemies"), workspace:FindFirstChild("Characters")}

    for _, folder in pairs(folders) do
        if folder then
            for _, obj in ipairs(folder:GetChildren()) do
                local head = obj:FindFirstChild("Head")
                if head and self:IsAlive(obj) and obj ~= myChar then
                    if (head.Position - myPos).Magnitude < Settings.Distance then
                        table.insert(targets, {obj, head})
                    end
                end
            end
        end
    end
    return targets
end

function FastAttackModule:Execute()
    -- æª¢æŸ¥ï¼š1.å…¨åŸŸé–‹é—œ 2.è…³æœ¬ID 3.æ‰‹ä¸Šæ˜¯å¦æœ‰åˆ€
    if not _G.FastAttack or _G.CurrentFastAtkID ~= scriptId then return end
    
    local tool = Player.Character and Player.Character:FindFirstChildOfClass("Tool")
    if not (tool and tool.ToolTip ~= "Gun") then return end

    local targets = self:GetTargets()
    if #targets > 0 then
        -- é€™è£¡åªå–ç¬¬ä¸€å€‹ Target çš„ Head ä½œç‚ºä¸»è¦ç›®æ¨™ï¼Œä½†å‚³é€æ•´å€‹ targets è¡¨
        local primaryHead = targets[1][2] 
        RegisterAttack:FireServer(Settings.ClickDelay)
        RegisterHit:FireServer(primaryHead, targets)
    end
end

-- ===== 3. åœæ­¢èˆ‡æ¸…ç†å‡½æ•¸ =====
local function StopScript()
    FastAttackModule.IsRunning = false
    if _G.CurrentFastAtkID == scriptId then
        _G.CurrentFastAtkID = nil
    end
    print("ğŸ›‘ FastAttack Cleanly Stopped.")
end

-- ===== 4. åŸ·è¡Œè¿´åœˆ =====
task.spawn(function()
    print("ğŸš€ Speed Mode Activated | ID: " .. scriptId)
    
    while FastAttackModule.IsRunning do
        -- å¦‚æœ ID è¢«æ›´æ–°ï¼ˆä»£è¡¨å•Ÿå‹•äº†æ–°è…³æœ¬ï¼‰ï¼Œå‰‡è‡ªæˆ‘çµ‚æ­¢
        if _G.CurrentFastAtkID ~= scriptId then 
            StopScript()
            break 
        end

        if _G.FastAttack then
            pcall(function() FastAttackModule:Execute() end)
        end
        
        task.wait(Settings.ClickDelay)
    end
end)
