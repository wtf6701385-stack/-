-- [[ 核心设置 ]]
local MAX_SCAN_COUNT = 30 -- 【新增】每次扫描最多处理的目标数，防止扫描过多导致卡顿
local ATTACK_SPEED_PLAYER = 0.06
local ATTACK_SPEED_NPC = 0.1

-- ... (前面的服务和函数定义保持不变) ...

task.spawn(function()
    while true do
        local currentWait = 0.1 -- 默认无目标时的等待

        if _G.PVP then
            local char = Player.Character
            local root = GetRoot(char)
            local tool = char and char:FindFirstChildOfClass("Tool")

            if tool and root then
                local allTargets = {}
                local myPos = root.Position
                local scannedCount = 0 -- 【新增】当前已扫描计数器
                
                local folders = {
                    workspace:FindFirstChild("Characters"), 
                    workspace:FindFirstChild("Enemies"), 
                    workspace:FindFirstChild("NPCs")
                }

                -- 开始扫描文件夹
                for _, folder in ipairs(folders) do
                    if folder then
                        local children = folder:GetChildren()
                        for i = 1, #children do
                            -- 【关键改动】如果已经找够了数量，直接跳出本文件夹的循环
                            if scannedCount >= MAX_SCAN_COUNT then break end

                            local m = children[i]
                            if m ~= char and IsAlive(m) then
                                local tr = GetRoot(m)
                                if tr and (tr.Position - myPos).Magnitude <= 1500 then
                                    local isPlayer = Players:GetPlayerFromCharacter(m) ~= nil
                                    table.insert(allTargets, {Model = m, Root = tr, IsPlayer = isPlayer})
                                    
                                    scannedCount = scannedCount + 1 -- 增加计数
                                end
                            end
                        end
                    end
                    -- 如果已经达到上限，停止扫描后续文件夹
                    if scannedCount >= MAX_SCAN_COUNT then break end
                end

                -- 执行攻击逻辑 (保持不变)
                if #allTargets > 0 then
                    local targetData = allTargets[1]
                    RegAttack:FireServer(0)
                    
                    local hitList = {}
                    for i = 1, #allTargets do 
                        table.insert(hitList, {allTargets[i].Model, allTargets[i].Root}) 
                    end
                    
                    RegHit:FireServer(targetData.Root, hitList)

                    if targetData.IsPlayer then
                        currentWait = ATTACK_SPEED_PLAYER
                    else
                        currentWait = ATTACK_SPEED_NPC
                    end
                end
            end
        end
        task.wait(currentWait)
    end
end)
