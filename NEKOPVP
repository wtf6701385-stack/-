-- 在脚本最前面加一个变量
local ScriptID = "NekoPVP_" .. tick() -- 给当前运行的脚本一个唯一身份
_G.CurrentPvpID = ScriptID -- 告诉全局：现在是我在跑

-- ... (中间的扫描、打包、发包函数保持不变) ...

-- ==========================================
-- 【第 1 步：核心控制层】
-- ==========================================
task.spawn(function()
    -- 只有当 ID 匹配且全局开关开启时才运行
    while _G.PVP and _G.CurrentPvpID == ScriptID do
        local waitTime = 0.1 

        local char = Player.Character
        local root = GetRoot(char)
        local tool = char and char:FindFirstChildOfClass("Tool")

        if tool and root then
            local rawModels = ScanEnvironment(root.Position, char)
            if #rawModels > 0 then
                local finalHitList = PreparePackage(rawModels)
                if #finalHitList > 0 then
                    local primaryRoot = finalHitList[1][2]
                    SendAttack(primaryRoot, finalHitList)
                    local isPlayer = Players:GetPlayerFromCharacter(rawModels[1]) ~= nil
                    waitTime = isPlayer and ATTACK_SPEED_PLAYER or ATTACK_SPEED_NPC
                end
            end
        end
        task.wait(waitTime)
    end
    print("猫猫打架脚本已安全退出") -- 退出循环后的提示
end)
