-- [[ NEKO x 凌霄 2025 : 虛擬座標欺騙 x 強制捕獲核心 ]]

if not _G.FastAttack then return end
local SessionID = _G.CurrentFastAtkID
local LP = game.Players.LocalPlayer

local Net = game:GetService("ReplicatedStorage"):WaitForChild("Modules"):WaitForChild("Net")
local RegAttack = Net:WaitForChild("RE/RegisterAttack")
local RegHit = Net:WaitForChild("RE/RegisterHit")

-- [ 幽靈捕獲配置 ]
local Config = {
    PlayerDist = 5000,   -- 5000 預瞄玩家
    BringDist = 1500,    -- 1500 強制拉扯 + 假座標攻擊
    MaxTargets = 20,
    MinDelay = 0.08, 
    MaxDelay = 0.15 
}

-- [ 核心邏輯：目標過濾與強制拉扯 ]
local function ProcessTargets()
    local targets = {}
    local char = LP.Character
    if not (char and char:FindFirstChild("HumanoidRootPart")) then return targets end
    local myRoot = char.HumanoidRootPart
    local myPos = myRoot.Position
    
    local allCandidates = {}
    
    -- 1. 蒐集玩家 (優先)
    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= LP and p.Character and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            local root = p.Character:FindFirstChild("HumanoidRootPart")
            if root and (root.Position - myPos).Magnitude <= Config.PlayerDist then
                table.insert(allCandidates, {v = p.Character, r = root})
            end
        end
    end
    
    -- 2. 蒐集怪物
    for _, v in pairs(workspace:GetChildren()) do
        local h = v:FindFirstChild("Humanoid")
        local root = v:FindFirstChild("HumanoidRootPart")
        if h and h.Health > 0 and root and not game.Players:GetPlayerFromCharacter(v) then
            if (root.Position - myPos).Magnitude <= Config.BringDist then
                table.insert(allCandidates, {v = v, r = root})
            end
        end
    end

    -- 3. 強制拉扯邏輯
    local finalTargets = {}
    for i, data in ipairs(allCandidates) do
        if i > Config.MaxTargets then break end
        
        local dist = (data.r.Position - myPos).Magnitude
        if dist <= Config.BringDist then
            -- 【強制拉扯】：只拉敵人，不移動主人
            pcall(function()
                data.r.CFrame = myRoot.CFrame * CFrame.new(0, 0, -3) -- 拉到主人面前 3 格
            end)
        end
        table.insert(finalTargets, {data.v, data.r})
    end
    return finalTargets
end

-- ==========================================
-- 【核心 A：純粹偽裝與訊號硬灌】
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        local tool = LP.Character and LP.Character:FindFirstChildOfClass("Tool")
        if tool and (tool.ToolTip == "Melee" or tool.ToolTip == "Sword" or tool.ToolTip == "Blox Fruit") then
            task.spawn(function() tool:Activate() end)
            -- 這裡只發送攻擊訊號，身體絕對不動
            RegAttack:FireServer(0.125)
        end
        task.wait(math.random(Config.MinDelay * 100, Config.MaxDelay * 100) / 100)
    end
end)

-- ==========================================
-- 【核心 B：假座標填充引擎】
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        game:GetService("RunService").RenderStepped:Wait()
        local tool = LP.Character and LP.Character:FindFirstChildOfClass("Tool")
        if tool and (tool.ToolTip == "Melee" or tool.ToolTip == "Sword" or tool.ToolTip == "Blox Fruit") then
            local enemies = ProcessTargets()
            if #enemies > 0 then
                local hitData = {}
                for _, data in ipairs(enemies) do
                    table.insert(hitData, {data[1], data[2]})
                end
                pcall(function()
                    for i = 1, 8 do 
                        -- 【虛擬擊中】：直接硬灌數據，伺服器會判斷目標已經被主人「隔空」打爛了
                        RegHit:FireServer(tool, hitData)
                    end
                end)
            end
        end
    end
end)
