-- [[ NEKO x å‡Œéœ„ 2025 : å¹½éˆç¬æ®º x éšç´šå¡«å…… x ç¡¬çŒå”è­° ]]
-- æ­¤è…³æœ¬å°ˆé–€ä¾›ä¸»è…³æœ¬ loadstring ä½¿ç”¨ï¼Œå…·å‚™å®Œæ•´çš„è‡ªæ®ºå”è­°

if not _G.FastAttack then return end
local SessionID = _G.CurrentFastAtkID -- ç¶å®šä¸»è…³æœ¬ KillCombat è¨Šè™Ÿ
local LP = game.Players.LocalPlayer

local Net = game:GetService("ReplicatedStorage"):WaitForChild("Modules"):WaitForChild("Net")
local RegAttack = Net:WaitForChild("RE/RegisterAttack")
local RegHit = Net:WaitForChild("RE/RegisterHit")
local oldPos = nil 

-- [ ç©¶æ¥µæ®ºæˆ®é…ç½® ]
local Config = {
    PlayerDist = 5000,   -- 5000 è·é›¢é–å®šç©å®¶
    BringDist = 1500,    -- 1500 å•Ÿå‹•ã€Œå¼·åˆ¶æŠ“å–ã€èˆ‡ã€Œå¹½éˆç¬æ®ºã€
    MaxTargets = 20,     -- 20 ç›®æ¨™å¡«å……ä¸Šé™
    TeleportOffset = 3,  -- ç¬ç§»åç½®
    MinDelay = 0.08, 
    MaxDelay = 0.15 
}

-- [ ç›®æ¨™è™•ç†ï¼šå¼·åˆ¶æŠ“å–èˆ‡ç©å®¶å„ªå…ˆé‚è¼¯ ]
local function ProcessTargets()
    local targets = {}
    local char = LP.Character
    if not (char and char:FindFirstChild("HumanoidRootPart")) then return targets end
    local myRoot = char.HumanoidRootPart
    local myPos = myRoot.Position
    
    local allCandidates = {}
    
    -- 1. å„ªå…ˆé–å®šç©å®¶ (5000 ç¯„åœ)
    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= LP and p.Character and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            local root = p.Character:FindFirstChild("HumanoidRootPart")
            if root and (root.Position - myPos).Magnitude <= Config.PlayerDist then
                table.insert(allCandidates, {v = p.Character, r = root})
            end
        end
    end
    
    -- 2. è£œå……æ€ªç‰© (1500 ç¯„åœå…§ä¸”æœ‰è¡€é‡)
    for _, v in pairs(workspace:GetChildren()) do
        local h = v:FindFirstChild("Humanoid")
        local root = v:FindFirstChild("HumanoidRootPart")
        if h and h.Health > 0 and root and not game.Players:GetPlayerFromCharacter(v) then
            if (root.Position - myPos).Magnitude <= Config.BringDist then
                table.insert(allCandidates, {v = v, r = root})
            end
        end
    end

    -- 3. è™•ç†ç¬ç§»èˆ‡æŠ“å–
    local activeTargets = {}
    for i, data in ipairs(allCandidates) do
        if i > Config.MaxTargets then break end
        
        local dist = (data.r.Position - myPos).Magnitude
        if dist <= Config.BringDist then
            if not oldPos then oldPos = myRoot.CFrame end
            pcall(function()
                -- æ ¸å¿ƒ Aï¼šå¹½éˆç¬ç§» (èº«é‚Šæ”»æ“Š)
                myRoot.CFrame = data.r.CFrame * CFrame.new(0, 0, Config.TeleportOffset)
                -- æ ¸å¿ƒ Bï¼šå¼·åˆ¶æŠ“å– (æ‹‰åˆ°é¢å‰)
                data.r.CFrame = myRoot.CFrame * CFrame.new(0, 0, -Config.TeleportOffset)
            end)
        end
        table.insert(activeTargets, {data.v, data.r})
    end
    return activeTargets
end

-- ==========================================
-- ã€æ ¸å¿ƒå¼•æ“ Aï¼šå¹½éˆè§¸ç™¼èˆ‡ç¡¬çŒå”è­°ã€‘
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        local char = LP.Character
        local tool = char and char:FindFirstChildOfClass("Tool")
        if tool and (tool.ToolTip == "Melee" or tool.ToolTip == "Sword" or tool.ToolTip == "Blox Fruit") then
            task.spawn(function() tool:Activate() end) 
            -- ç›´æ¥å®£å‘Šå‘½ä¸­ (ç¡¬çŒå”è­°)
            RegAttack:FireServer(0.125) 
        end
        task.wait(math.random(Config.MinDelay * 100, Config.MaxDelay * 100) / 100)
        
        -- å®‰å…¨è¿”å›åŸå§‹åº§æ¨™
        if oldPos and char and char.HumanoidRootPart then
            pcall(function() char.HumanoidRootPart.CFrame = oldPos end)
            oldPos = nil 
        end
    end
end)

-- ==========================================
-- ã€æ ¸å¿ƒå¼•æ“ Bï¼šæ¥µé™å¡«å……èˆ‡ 20 ç›®æ¨™æŠ¹é™¤ã€‘
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        game:GetService("RunService").RenderStepped:Wait()
        local tool = LP.Character and LP.Character:FindFirstChildOfClass("Tool")
        if tool and (tool.ToolTip == "Melee" or tool.ToolTip == "Sword" or tool.ToolTip == "Blox Fruit") then
            local enemies = ProcessTargets()
            if #enemies > 0 then
                local hitData = {}
                for _, data in ipairs(enemies) do
                    table.insert(hitData, {data[1], data[2]})
                end
                pcall(function()
                    -- 8 å€æš´åŠ›å¡«å……
                    for i = 1, 8 do 
                        RegHit:FireServer(tool, hitData)
                    end
                end)
            end
        end
    end
    print("ğŸ’€ å¹½éˆæ ¸å¿ƒï¼šè‡ªæ®ºå”è­°å·²åŸ·è¡Œï¼Œä»£ç¢¼æ¸…ç†å®Œç•¢ã€‚")
end)
