-- [[ Neko x FastAttack 終極整合穩定版 ]]
_G.PVP = true
_G.FastAttack = true

-- 自殺協議：確保重複執行時舊腳本自動釋放
local scriptId = "ElitePvp_" .. tick()
_G.CurrentPvpID = scriptId

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Player = Players.LocalPlayer

local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegAttack = Net:WaitForChild("RE/RegisterAttack")
local RegHit = Net:WaitForChild("RE/RegisterHit")

-- 原始設定數值 (完全保留)
local Settings = {
    Distance = 1500,     
    EnemyRate = 0.5,    
    PlayerRate = 0.03,  
    MaxScan = 30,       
    AttackRate = 0.01   
}

-- 緩存容器
local TargetCache = {
    Enemies = {},
    Players = {}
}

-- 核心工具函數
local function GetRoot(c) 
    return c and (c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("Head")) 
end

local function IsAlive(c)
    local h = c and c:FindFirstChildOfClass("Humanoid")
    return h and h.Health > 0
end

---

-- [[ 執行緒 1：怪物掃描 ]]
task.spawn(function()
    while _G.CurrentPvpID == scriptId and _G.PVP do
        local temp = {}
        local char = Player.Character
        local root = GetRoot(char)
        local folders = {workspace:FindFirstChild("Enemies"), workspace:FindFirstChild("NPCs")}
        
        if root then
            local myPos = root.Position
            for _, folder in ipairs(folders) do
                if folder then
                    local children = folder:GetChildren()
                    for i = 1, #children do
                        if #temp >= Settings.MaxScan then break end
                        local m = children[i]
                        local mRoot = GetRoot(m)
                        if mRoot and IsAlive(m) then
                            if (mRoot.Position - myPos).Magnitude <= Settings.Distance then
                                table.insert(temp, {m, mRoot})
                            end
                        end
                    end
                end
                if #temp >= Settings.MaxScan then break end
            end
        end
        TargetCache.Enemies = temp
        task.wait(Settings.EnemyRate)
    end
end)

-- [[ 執行緒 2：玩家掃描 ]]
task.spawn(function()
    while _G.CurrentPvpID == scriptId and _G.PVP do
        local temp = {}
        local char = Player.Character
        local root = GetRoot(char)
        local folder = workspace:FindFirstChild("Characters")
        
        if root and folder then
            local myPos = root.Position
            local children = folder:GetChildren()
            for i = 1, #children do
                if #temp >= Settings.MaxScan then break end
                local m = children[i]
                if m ~= char then
                    local mRoot = GetRoot(m)
                    if mRoot and IsAlive(m) then
                        if (mRoot.Position - myPos).Magnitude <= Settings.Distance then
                            table.insert(temp, {m, mRoot})
                        end
                    end
                end
            end
        end
        TargetCache.Players = temp
        task.wait(Settings.PlayerRate)
    end
end)

-- [[ 執行緒 3：核心攻擊輸出 ]]
task.spawn(function()
    print("Neko 整合模組已啟動 (ID: "..scriptId..")")
    
    while _G.CurrentPvpID == scriptId and _G.PVP do
        local char = Player.Character
        local tool = char and char:FindFirstChildOfClass("Tool")
        
        if tool and tool.ToolTip ~= "Gun" then
            local allTargets = {}
            local primaryPart = nil
            
            -- 玩家優先整合
            local pCache = TargetCache.Players
            for i = 1, #pCache do
                local data = pCache[i]
                if data[1] and data[1].Parent then -- 確保目標尚未銷毀
                    table.insert(allTargets, data)
                    if not primaryPart then primaryPart = data[2] end
                end
            end
            
            -- 怪物補位整合
            local eCache = TargetCache.Enemies
            for i = 1, #eCache do
                if #allTargets >= Settings.MaxScan then break end
                local data = eCache[i]
                if data[1] and data[1].Parent then
                    table.insert(allTargets, data)
                    if not primaryPart then primaryPart = data[2] end
                end
            end

            -- 執行遠端調用
            if primaryPart and primaryPart.Parent and #allTargets > 0 then
                RegAttack:FireServer(0)
                RegHit:FireServer(primaryPart, allTargets)
            end
        end
        task.wait(Settings.AttackRate)
    end
    print("舊腳本 ("..scriptId..") 已關閉。")
end)
