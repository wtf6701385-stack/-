-- [[ NEKO x 凌霄 2025 : V9 偽裝命脈核心 ]]
-- 核心邏輯：修正 GhoulSwing 缺失問題，模擬真實 DMG 封包格式

if not _G.FastAttack then return end
local SessionID = _G.CurrentFastAtkID
local LP = game.Players.LocalPlayer

local Net = game:GetService("ReplicatedStorage"):WaitForChild("Modules"):WaitForChild("Net")
local RegAttack = Net:WaitForChild("RE/RegisterAttack")
local RegHit = Net:WaitForChild("RE/RegisterHit")

-- [ 針對截圖的優化配置 ]
local Config = {
    PlayerDist = 5000,
    MonsterDist = 1500,
    MaxTargets = 20,
    AttackName = "Slash" -- 嘗試改用通用的攻擊名稱
}

local function GetEnemies()
    local targets = {}
    local char = LP.Character
    if not (char and char.PrimaryPart) then return targets end
    for _, v in pairs(workspace:GetChildren()) do
        local h = v:FindFirstChild("Humanoid")
        local r = v:FindFirstChild("HumanoidRootPart")
        if h and h.Health > 0 and r and v ~= char then
            local isP = game.Players:GetPlayerFromCharacter(v)
            if (isP and (r.Position - char.PrimaryPart.Position).Magnitude <= Config.PlayerDist) or 
               (not isP and (r.Position - char.PrimaryPart.Position).Magnitude <= Config.MonsterDist) then
                table.insert(targets, {v, r})
            end
        end
        if #targets >= Config.MaxTargets then break end
    end
    return targets
end

-- ==========================================
-- 【核心 A：動作補完】(解決 DOES NOT EXIST 報錯)
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        local tool = LP.Character and LP.Character:FindFirstChildOfClass("Tool")
        if tool then
            -- 修正：不僅要 Activate，還要發送正確的攻擊標籤
            task.spawn(function() tool:Activate() end)
            RegAttack:FireServer(0.125) -- 維持截圖中看到的攻擊頻率
        end
        task.wait(0.12)
    end
end)

-- ==========================================
-- 【核心 B：精準傷害注入】(適配截圖格式)
-- ==========================================
task.spawn(function()
    while _G.FastAttack and _G.CurrentFastAtkID == SessionID do
        game:GetService("RunService").Heartbeat:Wait() -- 改用 Heartbeat 同步
        local tool = LP.Character and LP.Character:FindFirstChildOfClass("Tool")
        if tool then
            local enemies = GetEnemies()
            if #enemies > 0 then
                pcall(function()
                    -- 修正：根據截圖，我們需要模擬「一對一」的命中封包
                    for _, data in ipairs(enemies) do
                        local enemyChar = data[1]
                        local enemyPart = data[2]
                        -- 2025 最新封包格式：模擬 Sword 的真實打擊
                        RegHit:FireServer(tool, {{enemyChar, enemyPart}})
                    end
                end)
            end
        end
    end
end)
