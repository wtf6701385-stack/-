local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LP = Players.LocalPlayer
if _G.PvpLoopStarted then return end
_G.PvpLoopStarted = true

local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegAtk, RegHit = Net:WaitForChild("RE/RegisterAttack"), Net:WaitForChild("RE/RegisterHit")

task.spawn(function()
    while true do
        if _G.PVP then
            pcall(function()
                local char = LP.Character
                local myRoot = char and char:FindFirstChild("HumanoidRootPart")
                local tool = char and char:FindFirstChildOfClass("Tool")
                if myRoot and tool then
                    local targets = {}; local mainPart = nil
                    for _, p in ipairs(Players:GetPlayers()) do
                        if p ~= LP and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                            local hum = p.Character:FindFirstChildOfClass("Humanoid")
                            if hum and hum.Health > 0 then
                                local root = p.Character.HumanoidRootPart
                                if (root.Position - myRoot.Position).Magnitude < 2000 then
                                    if not mainPart then mainPart = root end
                                    table.insert(targets, p.Character)
                                end
                            end
                        end
                    end
                    if #targets > 0 then RegAtk:FireServer(0); RegHit:FireServer(mainPart, targets) end
                end
            end)
        end
        task.wait(0.1)
    end
end)
