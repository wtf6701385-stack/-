-- [[ Neko x FastAttack : Toggle Safe PVP Edition ]]

-- ===== 0. è‡ªæ®ºå”è­°ï¼ˆé˜²é‡è¤‡ã€é˜²æ®˜ç•™ï¼‰=====
local scriptId = "NekoFastAtk_" .. tick()
_G.CurrentFastAtkID = scriptId

-- é è¨­ç”± UI æŽ§åˆ¶ï¼ˆUI ON = true / OFF = falseï¼‰
_G.FastAttack = _G.FastAttack or false

-- ===== 1. åŽŸå§‹ç’°å¢ƒ =====
local _ENV = (getgenv or getrenv or getfenv)()

local function SafeWaitForChild(parent, childName)
    local success, result = pcall(function()
        return parent:WaitForChild(childName)
    end)
    if not success or not result then
        warn("noooooo: " .. childName)
    end
    return result
end

local function WaitChilds(path, ...)
    local last = path
    for _, child in {...} do
        last = last:FindFirstChild(child) or SafeWaitForChild(last, child)
        if not last then break end
    end
    return last
end

-- ===== 2. Servicesï¼ˆåŽŸå§‹ä¿ç•™ï¼‰=====
local VirtualInputManager = game:GetService("VirtualInputManager")
local CollectionService = game:GetService("CollectionService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
if not Player then return end

local Remotes = SafeWaitForChild(ReplicatedStorage, "Remotes")
if not Remotes then return end

local Validator = SafeWaitForChild(Remotes, "Validator")
local CommF = SafeWaitForChild(Remotes, "CommF_")
local CommE = SafeWaitForChild(Remotes, "CommE")

local WorldOrigin = SafeWaitForChild(workspace, "_WorldOrigin")
local Characters = SafeWaitForChild(workspace, "Characters")
local Enemies = SafeWaitForChild(workspace, "Enemies")

local Modules = SafeWaitForChild(ReplicatedStorage, "Modules")
local Net = SafeWaitForChild(Modules, "Net")

-- ===== 3. åŽŸå§‹è¨­å®šï¼ˆä¸å‹•ï¼‰=====
local Settings = {
    AutoClick = true,
    ClickDelay = 0.000000000000000000000000000000000001
}

-- ===== 4. FastAttack åŽŸå§‹æ¨¡çµ„ï¼ˆå®Œæ•´ä¿ç•™ï¼‰=====
if not _ENV.rz_FastAttack then
    local FastAttack = {
        Distance = 200000,
        attackMobs = true,
        attackPlayers = true,
        Equipped = nil
    }

    local RegisterAttack = SafeWaitForChild(Net, "RE/RegisterAttack")
    local RegisterHit = SafeWaitForChild(Net, "RE/RegisterHit")

    local function IsAlive(character)
        return character
            and character:FindFirstChild("Humanoid")
            and character.Humanoid.Health > 0
    end

    local function ProcessEnemies(OthersEnemies, Folder)
        local BasePart
        for _, Enemy in Folder:GetChildren() do
            local Head = Enemy:FindFirstChild("Head")
            if Head and IsAlive(Enemy)
            and Player:DistanceFromCharacter(Head.Position) < FastAttack.Distance
            and Enemy ~= Player.Character then
                table.insert(OthersEnemies, { Enemy, Head })
                BasePart = Head
            end
        end
        return BasePart
    end

    function FastAttack:Attack(BasePart, OthersEnemies)
        if not BasePart or #OthersEnemies == 0 then return end
        RegisterAttack:FireServer(Settings.ClickDelay or 0)
        RegisterHit:FireServer(BasePart, OthersEnemies)
    end

    function FastAttack:AttackNearest()
        local OthersEnemies = {}
        local p1 = ProcessEnemies(OthersEnemies, Enemies)
        local p2 = ProcessEnemies(OthersEnemies, Characters)
        if #OthersEnemies > 0 then
            self:Attack(p1 or p2, OthersEnemies)
        else
            task.wait(0)
        end
    end

    function FastAttack:BladeHits()
        local Equipped = IsAlive(Player.Character)
            and Player.Character:FindFirstChildOfClass("Tool")
        if Equipped and Equipped.ToolTip ~= "Gun" then
            self:AttackNearest()
        else
            task.wait(0)
        end
    end

    _ENV.rz_FastAttack = FastAttack
end

-- ===== 5. æŽ§åˆ¶æ®¼ï¼ˆçœŸæ­£çš„ ON / OFF æ ¸å¿ƒï¼‰=====
task.spawn(function()
    print("âœ… Neko FastAttack PVP Loaded | ID:", scriptId)

    while _G.CurrentFastAtkID == scriptId do
        if _G.FastAttack and Settings.AutoClick then
            pcall(function()
                _ENV.rz_FastAttack:BladeHits()
            end)
        end
        task.wait(Settings.ClickDelay)
    end

    print("ðŸ›‘ Neko FastAttack PVP Stopped | ID:", scriptId)
end)
